openapi: 3.0.3
info:
  title: Skylens API
  description: |
    Performance dashboard microservice for hub metrics.
  version: 1.0.0
  contact:
    name: API Support

servers:
  - url: https://api-staging-services.jumia.com/skylens
    description: Base API path

tags:
  - name: Metrics
    description: Service provider level metrics
  - name: Configuration
    description: Thresholds and boundaries management
  - name: Reference Data
    description: Endpoints for static or reference data

paths:
  /api/v1/service-providers/{serviceProviderSid}/metrics/deliveries:
    get:
      tags:
        - Metrics
      summary: Get delivery metrics
      operationId: getPackageDeliveries
      x-spring-provide-args: [ '@com.jumia.skylens.http.in.headers.AuthorizationHeader com.jumia.skylens.http.in.acl.authentication.AuthToken authToken' ]
      parameters:
        - $ref: '#/components/parameters/serviceProviderSidPath'
        - $ref: '#/components/parameters/hubSid'
        - $ref: '#/components/parameters/dateRange'
        - $ref: '#/components/parameters/paymentType'
        - $ref: '#/components/parameters/movementType'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeliveryMetricsResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/service-providers/{serviceProviderSid}/metrics/success-rate:
    get:
      tags:
        - Metrics
      summary: Get success rate metrics
      operationId: getSuccessRate
      x-spring-provide-args: [ '@com.jumia.skylens.http.in.headers.AuthorizationHeader com.jumia.skylens.http.in.acl.authentication.AuthToken authToken' ]
      parameters:
        - $ref: '#/components/parameters/serviceProviderSidPath'
        - $ref: '#/components/parameters/hubSid'
        - $ref: '#/components/parameters/dateRange'
        - $ref: '#/components/parameters/paymentType'
        - $ref: '#/components/parameters/movementType'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessRateMetricsResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/service-providers/{serviceProviderSid}/metrics/loss-rate:
    get:
      tags:
        - Metrics
      summary: Get loss rate metrics
      operationId: getLossRate
      x-spring-provide-args: [ '@com.jumia.skylens.http.in.headers.AuthorizationHeader com.jumia.skylens.http.in.acl.authentication.AuthToken authToken' ]
      parameters:
        - $ref: '#/components/parameters/serviceProviderSidPath'
        - $ref: '#/components/parameters/hubSid'
        - $ref: '#/components/parameters/dateRange'
        - $ref: '#/components/parameters/paymentType'
        - $ref: '#/components/parameters/movementType'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LossRateMetricsResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/service-providers/{serviceProviderSid}/metrics/no-attempts:
    get:
      tags:
        - Metrics
      summary: Get no attempts metrics
      operationId: getNoAttempts
      x-spring-provide-args: [ '@com.jumia.skylens.http.in.headers.AuthorizationHeader com.jumia.skylens.http.in.acl.authentication.AuthToken authToken' ]
      parameters:
        - $ref: '#/components/parameters/serviceProviderSidPath'
        - $ref: '#/components/parameters/hubSid'
        - $ref: '#/components/parameters/paymentType'
        - $ref: '#/components/parameters/movementType'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NoAttemptsMetricsResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/countries/{country}/thresholds/{reportType}:
    get:
      tags:
        - Configuration
      summary: Get threshold target for a country by report type
      operationId: getThresholdTarget
      x-spring-provide-args: [ '@com.jumia.skylens.http.in.headers.AuthorizationHeader com.jumia.skylens.http.in.acl.authentication.AuthToken authToken' ]
      parameters:
        - $ref: '#/components/parameters/countryPath'
        - $ref: '#/components/parameters/reportTypePath'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ThresholdResponse'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Configuration
      summary: Update threshold target for a country by report type
      operationId: setThresholdTarget
      x-spring-provide-args: [ '@com.jumia.skylens.http.in.headers.AuthorizationHeader com.jumia.skylens.http.in.acl.authentication.AuthToken authToken' ]
      parameters:
        - $ref: '#/components/parameters/countryPath'
        - $ref: '#/components/parameters/reportTypePath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ThresholdRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ThresholdResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/countries/{country}/boundaries/success-rate:
    get:
      tags:
        - Configuration
      summary: Get success rate boundaries
      operationId: getMetricBoundaries
      parameters:
        - $ref: '#/components/parameters/countryPath'
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessRateBoundary'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Configuration
      summary: Update success rate boundaries
      operationId: setMetricBoundaries
      parameters:
        - $ref: '#/components/parameters/countryPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SuccessRateBoundaryRequest'
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessRateBoundary'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/date-ranges:
    get:
      tags:
        - Reference Data
      summary: Get available date rages
      operationId: getDateRanges
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DateRangesResponse'

  /api/v1/payment-types:
    get:
      tags:
        - Reference Data
      summary: Get available payment types
      operationId: getPaymentTypes
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentTypesResponse'

  /api/v1/movement-types:
    get:
      tags:
        - Reference Data
      summary: Get available movement types
      operationId: getMovementTypes
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MovementTypesResponse'

components:
  parameters:
    serviceProviderSidPath:
      name: serviceProviderSid
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Service provider sid
      example: "38b41222-1528-4231-896d-3788a3a9d8d8"

    hubSid:
      name: hubSid
      in: query
      required: false
      schema:
        type: string
        format: uuid
      description: Hub sid
      example: "38b41222-1528-4231-896d-3788a3a9d8d8"

    countryPath:
      name: country
      in: path
      required: true
      schema:
        type: string
        minLength: 2
        maxLength: 2
      description: ISO country code
      example: "CI"

    reportTypePath:
      name: reportType
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/ReportType'

    dateRange:
      name: dateRange
      in: query
      required: true
      schema:
        $ref: '#/components/schemas/DateRange'

    paymentType:
      name: paymentType
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/PaymentType'

    movementType:
      name: movementType
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/MovementType'

  schemas:
    DateRange:
      type: string
      enum:
        - CURRENT_WEEK
        - LAST_WEEK
        - LAST_FOUR_WEEKS
        - CURRENT_MONTH
        - LAST_THREE_MONTHS
      description: |
        Date range selection affects response array size and date granularity:
        
        | Value             | Array Size | Granularity | Date Represents     |
        |-------------------|------------|-------------|---------------------|
        | CURRENT_WEEK      | 7          | Daily       | Each day            |
        | LAST_WEEK         | 7          | Daily       | Each day            |
        | LAST_FOUR_WEEKS   | 4          | Weekly      | Week start (Monday) |
        | CURRENT_MONTH     | 1          | Monthly     | Month start (1st)   |
        | LAST_THREE_MONTHS | 3          | Monthly     | Month start (1st)   |

    PaymentType:
      type: string
      enum:
        - PRE
        - POST
      description: |
        - PRE: Prepaid
        - POST: Postpaid

    MovementType:
      type: string
      enum:
        - DOOR
        - PUS
      description: |
        - DOOR: Door delivery
        - PUS: Pick up delivery

    ReportType:
      type: string
      enum:
        - SUCCESS_RATE
        - LOSS_RATE
      description: |
        - SUCCESS_RATE: Success rate report
        - LOSS_RATE: Loss rate report

    DeliveryMetricsResponse:
      type: array
      items:
        type: object
        required:
          - date
          - packagesDelivered
        properties:
          date:
            type: string
            format: date
            description: |
              - DAILY: The day
              - WEEKLY: Week start (Monday)
              - MONTHLY: Month start (1st)
          packagesDelivered:
            type: integer

    SuccessRateMetricsResponse:
      type: array
      items:
        type: object
        required:
          - date
          - packagesDelivered
          - packagesClosed
        properties:
          date:
            type: string
            format: date
          packagesDelivered:
            type: integer
          packagesClosed:
            type: integer
          successRate:
            type: number
            format: double
            nullable: true

    LossRateMetricsResponse:
      type: array
      items:
        type: object
        required:
          - date
          - packagesLost
          - packagesReceived
        properties:
          date:
            type: string
            format: date
          packagesLost:
            type: integer
          packagesReceived:
            type: integer
          lossRate:
            type: number
            format: double
            nullable: true

    NoAttemptsMetricsResponse:
      type: object
      required:
        - oneDay
        - twoDays
        - threeDays
        - overThreeDays
      properties:
        oneDay:
          type: integer
          description: Packages with 1 working date without attempt
        twoDays:
          type: integer
          description: Packages with 2 working days without attempt
        threeDays:
          type: integer
          description: Packages with 3 working days without attempt
        overThreeDays:
          type: integer
          description: Packages with >3 working days without attempt

    ThresholdResponse:
      type: object
      required:
        - targetRate
        - updatedAt
      properties:
        targetRate:
          type: number
          format: decimal
          minimum: 0
          maximum: 1
        updatedAt:
          type: string
          format: date-time

    ThresholdRequest:
      type: object
      required:
        - targetRate
      properties:
        targetRate:
          type: number
          format: decimal
          minimum: 0
          maximum: 1
          example: 0.85

    SuccessRateBoundary:
      type: object
      required:
        - metricType
        - warningThreshold
        - criticalThreshold
        - updatedAt
      properties:
        warningThreshold:
          type: number
          format: double
          minimum: 0
          maximum: 1
        criticalThreshold:
          type: number
          format: double
          minimum: 0
          maximum: 1
        updatedAt:
          type: string
          format: date-time

    SuccessRateBoundaryRequest:
      type: object
      required:
        - warningThreshold
        - criticalThreshold
      properties:
        warningThreshold:
          type: number
          format: double
          minimum: 0
          maximum: 1
          example: 0.90
        criticalThreshold:
          type: number
          format: double
          minimum: 0
          maximum: 1
          example: 0.80
    DateRangeOption:
      type: object
      required:
        - value
        - description
      properties:
        value:
          $ref: '#/components/schemas/DateRange'
        description:
          type: string
          description: Human-readable label for display
      example:
        value: CURRENT_WEEK
        description: Current Week

    DateRangesResponse:
      type: array
      items:
        $ref: '#/components/schemas/DateRangeOption'
      example:
        - value: CURRENT_WEEK
          description: Current Week
        - value: LAST_WEEK
          description: Last Week
        - value: LAST_FOUR_WEEKS
          description: Last 4 Weeks
        - value: CURRENT_MONTH
          description: Current Month
        - value: LAST_THREE_MONTHS
          description: Last 3 Months

    PaymentTypeOption:
      type: object
      required:
        - value
        - description
      properties:
        value:
          $ref: '#/components/schemas/PaymentType'
        description:
          type: string
          description: Human-readable label for display
      example:
        value: POST
        description: Post Paid

    PaymentTypesResponse:
        type: array
        items:
            $ref: '#/components/schemas/PaymentTypeOption'
        example:
          - value: PRE
            description: Pre Paid
          - value: POST
            description: Post Paid

    MovementTypeOption:
      type: object
      required:
        - value
        - description
      properties:
        value:
          $ref: '#/components/schemas/MovementType'
        description:
          type: string
          description: Human-readable label for display
      example:
        - value: DOOR
          description: Door Delivery
        - value: PUS
          description: Pick Up Delivery

    MovementTypesResponse:
      type: array
      items:
        $ref: '#/components/schemas/MovementTypeOption'
      example:
        - value: DOOR
          description: Door Delivery
        - value: PUS
          description: Pick Up Delivery

    Error:
      type: object
      properties:
        code:
          type: integer
          format: int64
          example: 1
        message:
          type: string
        codeName:
          type: string
        errors:
          type: string
      required:
        - code
        - message
